<h1>Personas relacionadas</h1>

<div class="cards-grid">
  <mat-card
    class="person-card"
    *ngFor="let p of people()"
    (click)="select(p)"
    [class.selected]="selectedId() === p.id"
    tabindex="0"
    [attr.aria-pressed]="selectedId() === p.id"
    [attr.aria-label]="'Seleccionar a ' + p.fullName">

    <div class="top">
      <!-- color dinámico -->
      <div class="avatar" [style.background]="p.color || '#4f46e5'">
        {{ initials(p.fullName) }}
      </div>

      <div class="text-block">
        <div class="name">{{ p.fullName }}</div>
        <mat-chip class="relation-chip" selected>{{ p.relation }}</mat-chip>
      </div>

      <button
        mat-icon-button
        class="menu-btn"
        (click)="$event.stopPropagation()"
        [matMenuTriggerFor]="menu"
        aria-label="Más opciones">
        <mat-icon>more_vert</mat-icon>
      </button>
    </div>

    <mat-menu #menu="matMenu" xPosition="before">
      <button mat-menu-item (click)="view(p)">
        <mat-icon>visibility</mat-icon>
        <span>Ver</span>
      </button>

      <button mat-menu-item (click)="edit(p)">
        <mat-icon>edit</mat-icon>
        <span>Editar</span>
      </button>

      <!-- AHORA: confirmar con modal -->
      <button mat-menu-item (click)="confirmRemove(p)">
        <mat-icon>delete</mat-icon>
        <span>Eliminar</span>
      </button>
    </mat-menu>
  </mat-card>

  <button class="add-card" (click)="addPerson()" aria-label="Agregar persona">
    <div class="add-dashed">
      <div class="plus">+</div>
      <div class="add-text">Agrega Persona</div>
    </div>
  </button>
</div>

<!-- Modal: Detalle -->
<ng-template #detailDialog let-data>
  <div class="modal-container">
    <div class="modal-header">
      <h2 class="modal-title">Detalles de Persona</h2>
      <button mat-icon-button class="close-btn" mat-dialog-close aria-label="Cerrar modal">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-content">
      <div class="person-info">
        <div class="avatar-container">
          <div class="person-avatar" [style.background]="data.color || '#4f46e5'">
            {{ initials(data.fullName) }}
          </div>
        </div>
        <div class="person-details">
          <h3 class="person-name">{{ data.fullName }}</h3>
          <p class="person-subtitle">{{ data.relation }}</p>
        </div>
      </div>

      <div class="details-section">
        <div class="detail-item">
          <div class="detail-icon"><mat-icon>badge</mat-icon></div>
          <div class="detail-content">
            <span class="detail-label">Identificación</span>
            <span class="detail-value">{{ data.document || '—' }}</span>
          </div>
        </div>

        <div class="detail-item">
          <div class="detail-icon"><mat-icon>assignment_ind</mat-icon></div>
          <div class="detail-content">
            <span class="detail-label">Tipo de documento</span>
            <span class="detail-value">{{ data.documentTypeName || '—' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button mat-flat-button color="primary" class="close-button" mat-dialog-close>
        Cerrar
      </button>
    </div>
  </div>
</ng-template>

<!-- Modal: Confirmar eliminación -->
<ng-template #confirmTpl>
  <h2 mat-dialog-title>Eliminar persona relacionada</h2>
  <div mat-dialog-content>
    <p>
      ¿Seguro que deseas eliminar a
      <strong>{{ toRemove?.fullName }}</strong> ({{ toRemove?.relation }})?
    </p>
  </div>
  <div mat-dialog-actions align="end">
    <button mat-stroked-button mat-dialog-close (click)="onCancelRemove()">Cancelar</button>
    <button mat-raised-button color="warn" (click)="onConfirmRemove()">Eliminar</button>
  </div>
</ng-template>

<!-- Modal: Éxito genérico -->
<ng-template #successTpl>
  <h2 mat-dialog-title>Operación exitosa</h2>
  <div mat-dialog-content>
    <p>{{ successMessage }}</p>
  </div>
  <div mat-dialog-actions align="end">
    <button mat-raised-button color="primary" mat-dialog-close>Aceptar</button>
  </div>
</ng-template>

<!-- Modal: Error genérico (opcional) -->
<ng-template #errorTpl>
  <h2 mat-dialog-title>Error</h2>
  <div mat-dialog-content>
    <p>{{ errorMessage }}</p>
  </div>
  <div mat-dialog-actions align="end">
    <button mat-raised-button color="warn" mat-dialog-close>Cerrar</button>
  </div>
</ng-template>
