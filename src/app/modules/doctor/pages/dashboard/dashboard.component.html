<section class="doctor-dashboard" *ngIf="!loading && !error; else loadingTpl">

    <!-- Hero con KPIs -->
    <div class="hero">
        <h2>Resumen del día</h2>
        <div class="kpis">
            <mat-card class="kpi">
                <div class="kpi-title">Citas atendidas</div>
                <div class="kpi-value">{{ vm.kpis.attendedToday }}</div>
                <mat-icon>verified</mat-icon>
            </mat-card>

            <mat-card class="kpi">
                <div class="kpi-title">Pacientes presentes</div>
                <div class="kpi-value">{{ vm.kpis.presentToday }}</div>
                <mat-icon>assignment_turned_in</mat-icon>
            </mat-card>

            <mat-card class="kpi">
                <div class="kpi-title">Pacientes ausentes</div>
                <div class="kpi-value">{{ vm.kpis.absentToday }}</div>
                <mat-icon>report_gmailerrorred</mat-icon>
            </mat-card>
        </div>
    </div>

    <div class="grid">
        <!-- Barras semanales -->
        <mat-card class="card">
            <div class="card-title">Todas las citas semanales por día</div>
            <div class="weekly-chart">
                <div class="chart-header">
                    <div class="chart-info">
                        <div class="total-citas">
                            <span class="total-number">{{ getTotalWeeklyCitas() }}</span>
                            <span class="total-label">citas esta semana</span>
                        </div>
                        <div class="peak-day">
                            <span class="peak-label">Día con más citas:</span>
                            <span class="peak-value">{{ getPeakDay() }}</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="y-axis">
                        <span *ngFor="let tick of getYAxisTicks()">{{ tick }}</span>
                    </div>
                    <div class="bars-container">
                        <div class="bar-wrapper" *ngFor="let lbl of vm.weeklyBars.labels; let i = index">
                            <div class="bar-container">
                                <div class="bar-value">{{ vm.weeklyBars.values[i] }}</div>
                                <div class="bar-visual">
                                    <div class="bar-fill"
                                         [style.height]="toPct(vm.weeklyBars.values[i], maxWeekly())"
                                         [class.peak]="isPeakDay(i)">
                                    </div>
                                </div>
                                <div class="bar-label">{{ lbl }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-footer">
                    <div class="status-legend">
                        <div class="legend-item">
                            <div class="legend-color peak"></div>
                            <span>Día con más citas</span>
                        </div>
                    </div>
                </div>
            </div>
        </mat-card>

        <!-- Donut asistencia -->
        <mat-card class="card">
            <div class="card-title">Asistencia de citas</div>
            <div class="donut-wrap">
                <div class="donut" [ngStyle]="donutStyle()">
                    <div class="donut-center">
                        <div class="center-number">{{ vm.donut.attended }}</div>
                        <div class="center-sub">asistieron</div>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-row">
                        <span class="dot dot-attended"></span>
                        <span>Asistieron</span>
                        <span class="value">{{ (vm.donut.attended / (vm.donut.attended + vm.donut.notAttended || 1) *
                            100) | number:'1.0-1' }}%</span>
                    </div>
                    <div class="legend-row">
                        <span class="dot dot-absent"></span>
                        <span>No asistieron</span>
                        <span class="value">{{ (vm.donut.notAttended / (vm.donut.attended + vm.donut.notAttended || 1) *
                            100) | number:'1.0-1' }}%</span>
                    </div>
                </div>
            </div>
        </mat-card>

        <!-- Turnos de la semana -->
        <mat-card class="card narrow">
            <div class="card-title">Turnos de la semana</div>
            <div class="shifts">
                <div class="shift-row" *ngFor="let s of vm.shifts">
                    <div class="day">{{ s.day }}</div>
                    <div class="track">
                        <div class="progress" [style.width]="toPct(s.hours, 8)"></div>
                    </div>
                    <div class="hours">{{ s.hours }}h</div>
                </div>
                <small class="hint">Estimado: {{ vm.slotMin / 60 | number:'1.1' }}h por cita.</small>
            </div>
        </mat-card>

        <!-- Próxima cita -->
        <mat-card class="mini">
            <div class="mini-title">Próxima cita</div>
            <ng-container *ngIf="vm.next; else noNext">
                <div class="next">
                    <mat-icon>event</mat-icon>
                    <div>
                        <div class="next-title">{{ vm.next.date | date:'EEEE, d MMM' }}</div>
                        <div class="next-sub">{{ vm.next.timeLabel }} · {{ vm.next.note || '—' }}</div>
                    </div>
                </div>
            </ng-container>
            <ng-template #noNext>
                <div class="empty">Sin próximas citas</div>
            </ng-template>
        </mat-card>

        <!-- Citas pendientes -->
        <mat-card class="mini">
            <div class="mini-title">Citas pendientes</div>
            <div class="pending">
                <div class="number">{{ vm.pendingCount }}</div>
                <div class="tag">¡importante!</div>
            </div>
        </mat-card>
    </div>

</section>

<ng-template #loadingTpl>
    <div class="loading">
        <ng-container *ngIf="loading">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
            <p>Cargando dashboard...</p>
        </ng-container>
        <ng-container *ngIf="error">
            <mat-icon color="warn">error</mat-icon>
            <p>{{ error }}</p>
            <button mat-raised-button color="primary" (click)="loadDashboard()">
                Reintentar
            </button>
        </ng-container>
    </div>
</ng-template>