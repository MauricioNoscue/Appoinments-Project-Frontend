<mat-stepper [linear]="isLinear" #stepper>

  <!-- Paso 1: Tipo de Cita -->
  <mat-step [stepControl]="firstFormGroup">
    <form [formGroup]="firstFormGroup">
      <ng-template matStepLabel>Seleccionar Tipo de Cita</ng-template>

      <div class="step-content">
        <h3>Elige el tipo de cita que necesitas</h3>

        <div class="grid">
          <mat-card
            *ngFor="let type of typeCitation"
            class="selection-card"
            [class.selected]="isSelected(type)"
            (click)="selectTypeCitation(type)"
            matRipple>
            <mat-icon class="icon">{{ type.icon }}</mat-icon>
            <h4>{{ type.name }}</h4>
            <mat-icon *ngIf="isSelected(type)" class="check-icon">check_circle</mat-icon>
          </mat-card>
        </div>

        <mat-error *ngIf="firstFormGroup.get('typeCitationId')?.invalid && firstFormGroup.get('typeCitationId')?.touched">
          Por favor selecciona un tipo de cita
        </mat-error>

        <mat-card *ngIf="selectedTypeCitation" class="info-card">
          <mat-card-content>
            <mat-icon class="icon">{{ selectedTypeCitation.icon }}</mat-icon>
            <div>
              <strong>{{ selectedTypeCitation.name }}</strong>
              <p>{{ selectedTypeCitation.description }}</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="step-actions">
        <button mat-raised-button color="primary" matStepperNext [disabled]="firstFormGroup.invalid">
          Siguiente
        </button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 2: Doctor -->
  <mat-step [stepControl]="secondFormGroup">
    <form [formGroup]="secondFormGroup">
      <ng-template matStepLabel>Seleccionar Doctor</ng-template>

      <div class="step-content">
        <h3>Elige el doctor para tu cita</h3>

        <div class="grid">
          <mat-card
            *ngFor="let doctor of doctorList"
            class="selection-card"
            [class.selected]="isSelectedDoctor(doctor)"
            (click)="selectDoctor(doctor)"
            matRipple>
            <img *ngIf="doctor.image" [src]="doctor.image" class="avatar" />
            <mat-icon *ngIf="!doctor.image" class="avatar">person</mat-icon>
            <h4>{{ doctor.fullName || 'Sin nombre' }}</h4>
            <mat-icon *ngIf="isSelectedDoctor(doctor)" class="check-icon">check_circle</mat-icon>
          </mat-card>
        </div>

        <div *ngIf="doctorList.length === 0" class="empty-message">
          <mat-icon>info</mat-icon>
          <p>No hay doctores disponibles</p>
        </div>

        <mat-error *ngIf="secondFormGroup.get('doctorId')?.invalid && secondFormGroup.get('doctorId')?.touched">
          Por favor selecciona un doctor
        </mat-error>

        <mat-card *ngIf="selectedDoctor" class="info-card">
          <mat-card-content>
            <img *ngIf="selectedDoctor.image" [src]="selectedDoctor.image" class="avatar" />
            <mat-icon *ngIf="!selectedDoctor.image" class="avatar">person</mat-icon>
            <div>
              <strong>{{ selectedDoctor.fullName }}</strong>
              <p>{{ selectedDoctor.specialtyName }}</p>
              <small>{{ selectedDoctor.emailDoctor }}</small>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="step-actions">
        <button mat-button matStepperPrevious>Atrás</button>
        <button mat-raised-button color="primary" matStepperNext [disabled]="secondFormGroup.invalid">
          Siguiente
        </button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 3: Consultorio -->
  <mat-step [stepControl]="thirdFormGroup">
    <form [formGroup]="thirdFormGroup">
      <ng-template matStepLabel>Seleccionar Consultorio</ng-template>

      <div class="step-content">
        <h3>Elige el consultorio</h3>

        <div class="grid">
          <mat-card
            *ngFor="let room of consultingRoomList"
            class="selection-card"
            [class.selected]="isSelectedRoom(room)"
            (click)="selectRoom(room)"
            matRipple>
            <mat-icon class="icon">meeting_room</mat-icon>
            <h4>{{ room.name }}</h4>
            <p>Sala {{ room.roomNumber }} - Piso {{ room.floor }}</p>
            <mat-icon *ngIf="isSelectedRoom(room)" class="check-icon">check_circle</mat-icon>
          </mat-card>
        </div>

        <div *ngIf="consultingRoomList.length === 0" class="empty-message">
          <mat-icon>info</mat-icon>
          <p>No hay consultorios disponibles</p>
        </div>

        <mat-error *ngIf="thirdFormGroup.get('consultingRoomId')?.invalid && thirdFormGroup.get('consultingRoomId')?.touched">
          Por favor selecciona un consultorio
        </mat-error>

        <mat-card *ngIf="selectedRoom" class="info-card">
          <mat-card-content>
            <mat-icon class="icon">meeting_room</mat-icon>
            <div>
              <strong>{{ selectedRoom.name }}</strong>
              <p>Sala {{ selectedRoom.roomNumber }} - Piso {{ selectedRoom.floor }}</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="step-actions">
        <button mat-button matStepperPrevious>Atrás</button>
        <button mat-raised-button color="primary" matStepperNext [disabled]="thirdFormGroup.invalid">
          Siguiente
        </button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 4: Número de Citas -->
  <mat-step [stepControl]="fourthFormGroup">
    <form [formGroup]="fourthFormGroup">
      <ng-template matStepLabel>Número de Citas</ng-template>

      <div class="step-content">
        <h3>¿Cuántas citas necesitas?</h3>

        <mat-form-field appearance="outline" class="number-input">
          <mat-label>Número de citas</mat-label>
          <input matInput type="number" formControlName="numberCitation" min="1" max="50" />
          <mat-hint>Mínimo 1, máximo 50</mat-hint>
        </mat-form-field>

        <div class="quick-buttons">
          <button *ngFor="let num of quickNumbers" mat-stroked-button (click)="selectQuickNumber(num)">
            {{ num }}
          </button>
        </div>

        <div class="confirmation" *ngIf="isFormComplete()">
          <mat-icon>check_circle</mat-icon>
          <div>
            <strong>¡Todo listo!</strong>
            <p>Tu solicitud está completa y lista para enviar.</p>
          </div>
        </div>
      </div>

      <div class="step-actions">
        <button mat-button matStepperPrevious>Atrás</button>
        <button mat-raised-button color="primary" type="button" [disabled]="!isFormComplete()" (click)="submitForm()">
          <mat-icon>send</mat-icon> Enviar Solicitud
        </button>
      </div>
    </form>
  </mat-step>

  <!-- Paso 5: Configurar Horarios -->
  <mat-step [stepControl]="fifthFormGroup">
    <form [formGroup]="fifthFormGroup">
      <ng-template matStepLabel>Configurar Horarios</ng-template>

      <div class="step-content">
        <h3>Configura los horarios de las citas</h3>

        <mat-card class="time-card">
          <mat-card-title><mat-icon>access_time</mat-icon> Horario de Trabajo</mat-card-title>
          <div class="time-row">
            <mat-form-field>
              <mat-label>Inicio</mat-label>
              <input matInput type="time" formControlName="startTime" />
            </mat-form-field>
            <mat-icon>arrow_forward</mat-icon>
            <mat-form-field>
              <mat-label>Fin</mat-label>
              <input matInput type="time" formControlName="endTime" />
            </mat-form-field>
          </div>
        </mat-card>

        <mat-card class="time-card">
          <mat-card-title><mat-icon>coffee</mat-icon> Descanso</mat-card-title>
          <div class="time-row">
            <mat-form-field>
              <mat-label>Inicio</mat-label>
              <input matInput type="time" formControlName="breakStartTime" />
            </mat-form-field>
            <mat-icon>arrow_forward</mat-icon>
            <mat-form-field>
              <mat-label>Fin</mat-label>
              <input matInput type="time" formControlName="breakEndTime" />
            </mat-form-field>
          </div>
        </mat-card>
      </div>

      <div class="step-actions">
        <button mat-button matStepperPrevious>Atrás</button>
        <button mat-raised-button color="primary" type="button" [disabled]="!isAllFormsComplete()" (click)="submitScheduleConfiguration()" class="submit-button">
          <mat-icon>schedule_send</mat-icon> Crear Horarios
        </button>
      </div>
    </form>
  </mat-step>
</mat-stepper>
